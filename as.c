#include "user.h"
#include "elf.h"


struct x86_prefix{
     const char* prefix;
     unsigned char opcode;
};

struct x86_prefix prefixes[] ={
     {"es",0x26},
     {"cs",0x2E},
     {"ss",0x36},
     {"ds",0x3E},
     {"fs",0x64},
     {"gs",0x65},
     {"",0x66},
     {"",0x67},
     {"",0x9B},
     {"lock",0xF0},
     {"repnz",0xF2},
     {"rep", 0xF2},
     {"",0xF3},
     {"repz", 0xF3},
     {"",0xF3},
};


struct x86_register{
     const char* name;
     unsigned size_and_kind;
     unsigned char regno;
};

struct x86_register registers[] = {
     {"al",1,0},
     {"cl",1,1},
     {"dl",1,2},
     {"bl",1,3},
     {"ah",1,4},
     {"ch",1,5},
     {"dh",1,6},
     {"bh",1,7},
     {"ax",2,0},
     {"cx",2,1},
     {"dx",2,2},
     {"bx",2,3},
     {"sp",2,4},
     {"bp",2,5},
     {"si",2,6},
     {"di",2,7},
     {"eax",4,0},
     {"ecx",4,1},
     {"edx",4,2},
     {"ebx",4,3},
     {"esp",4,4},
     {"ebp",4,5},
     {"esi",4,6},
     {"edi",4,7},
     {"es",0x102,0},
     {"cs",0x102,1},
     {"ss",0x102,2},
     {"ds",0x102,3},
     {"fs",0x102,4},
     {"gs",0x102,5},
     {"cr0",0x204,0},
     {"cr2",0x204,2},
     {"cr3",0x204,3},
     {"cr4",0x204,4},
     {"st",0x30a,0},
     {"st1",0x30a,1},
     {"st2",0x30a,2},
     {"st3",0x30a,3},
     {"st4",0x30a,4},
     {"st5",0x30a,5},
     {"st6",0x30a,6},
     {"st7",0x30a,7},
};

enum addr_mode{
     none,
     rel,
     modrm,
     reg,
     regfield,
     opreg,
     moffset,
     src,
     dest,
     areg,
     dreg,
     creg,
     farptr,
     imm,
     sreg
};

struct x86_instruction{
    const char* name;
    int opcode;
    enum addr_mode am1;
    enum addr_mode am2;
    enum addr_mode am3; 
};

struct x86_instruction insns[] = {
     {"add",0x00,modrm|0x100,reg|0x100},
     {"add",0x01,modrm,reg},
     {"add",0x02,reg|0x100,modrm|0x100},
     {"add",0x03,reg,modrm},
     {"add",0x04,areg|0x100,imm|0x100},
     {"add",0x05,areg,imm},
     {"push",0x06,sreg},
     {"pop",0x07,sreg},
     {"or",0x08,modrm|0x100,reg|0x100},
     {"or",0x09,modrm,reg},
     {"or",0x0a,reg|0x100,modrm|0x100},
     {"or",0x0b,reg,modrm},
     {"or",0x0c,areg|0x100,imm|0x100},
     {"or",0x0d,areg,imm},
     {"push",0x0e,sreg|0x100},
     {"adc",0x10,modrm|0x100,reg|0x100},
     {"adc",0x11,modrm,reg},
     {"adc",0x12,reg|0x100,modrm|0x100},
     {"adc",0x13,reg,modrm},
     {"adc",0x14,areg|0x100,imm|0x100},
     {"adc",0x15,areg,imm},
     {"push",0x16,sreg|0x200},
     {"pop",0x17,sreg|0x200},
     {"sbb",0x18,modrm|0x100,reg|0x100},
     {"sbb",0x19,modrm,reg},
     {"sbb",0x1a,reg|0x100,modrm|0x100},
     {"sbb",0x1b,reg,modrm},
     {"sbb",0x1c,areg|0x100,imm|0x100},
     {"sbb",0x1d,areg,imm},
     {"push",0x1e,sreg|0x300},
     {"pop",0x1f,sreg|0x300},
     {"and",0x20,modrm|0x100,reg|0x100},
     {"and",0x21,modrm,reg},
     {"and",0x22,reg|0x100,modrm|0x100},
     {"and",0x23,reg,modrm},
     {"and",0x24,areg|0x100,imm|0x100},
     {"and",0x25,areg,imm},
     {"daa",0x27},
     {"sbb",0x28,modrm|0x100,reg|0x100},
     {"sbb",0x29,modrm,reg},
     {"sbb",0x2a,reg|0x100,modrm|0x100},
     {"sbb",0x2b,reg,modrm},
     {"sbb",0x2c,areg|0x100,imm|0x100},
     {"sbb",0x2d,areg,imm},
     {"das",0x2f},
     {"xor",0x30,modrm|0x100,reg|0x100},
     {"xor",0x31,modrm,reg},
     {"xor",0x32,reg|0x100,modrm|0x100},
     {"xor",0x33,reg,modrm},
     {"xor",0x34,areg|0x100,imm|0x100},
     {"xor",0x35,areg,imm},
     {"aaa",0x37},
     {"cmp",0x38,modrm|0x100,reg|0x100},
     {"cmp",0x39,modrm,reg},
     {"cmp",0x3a,reg|0x100,modrm|0x100},
     {"cmp",0x3b,reg,modrm},
     {"cmp",0x3c,areg|0x100,imm|0x100},
     {"cmp",0x3d,areg,imm},
     {"aas",0x3f},
     {"inc",0x40,opreg},
     {"dec",0x48,opreg},
     {"push",0x50,opreg},
     {"pop",0x58,opreg},
     {"pusha",0x60},
     {"pushad",0x60},
     {"popa",0x61},
     {"popad",0x61},
     {"bound",0x62,modrm,reg},
     {"arpl",0x63,modrm|0x10200,reg|0x10200},
     {"push",0x68,imm},
     {"imul",0x69,reg,modrm,imm},
     {"push",0x6A,imm|0x100},
     {"imul",0x6B,reg,modrm,imm|0x100},
     {"insb",0x6C,dest|0x100},
     {"ins",0x6D,dest},
     {"outsb",0x6E,src|0x100},
     {"outs",0x6F,src},
     {"jo",0x70,rel|0x100},
     {"jno",0x71,rel|0x100},
     {"jb",0x72,rel|0x100},
     {"jnae",0x72,rel|0x100},
     {"jc",0x72,rel|0x100},
     {"jnb",0x73,rel|0x100},
     {"jae",0x73,rel|0x100},
     {"jnc",0x73,rel|0x100},
     {"jz",0x74,rel|0x100},
     {"je",0x74,rel|0x100},
     {"jnz",0x75,rel|0x100},
     {"jne",0x75,rel|0x100},
     {"jbe",0x76,rel|0x100},
     {"jna",0x76,rel|0x100},
     {"jnbe",0x77,rel|0x100},
     {"ja",0x77,rel|0x100},
     {"js",0x78,rel|0x100},
     {"jns",0x79,rel|0x100},
     {"jp",0x7A,rel|0x100},
     {"jpe",0x7A,rel|0x100},
     {"jnp",0x7B,rel|0x100},
     {"jpo",0x7B,rel|0x100},
     {"jl",0x7C,rel|0x100},
     {"jnge",0x7C,rel|0x100},
     {"jnl",0x7D,rel|0x100},
     {"jge",0x7D,rel|0x100},
     {"jle",0x7E,rel|0x100},
     {"jng",0x7E,rel|0x100},
     {"jnle",0x7F,rel|0x100},
     {"jg",0x7F,rel|0x100},
     {"add",0x80,regfield,modrm|0x100,imm|0x100},
     {"or",0x80,regfield|0x100,modrm|0x100,imm|0x100},
     {"adc",0x80,regfield|0x200,modrm|0x100,imm|0x100},
     {"sbb",0x80,regfield|0x300,modrm|0x100,imm|0x100},
     {"and",0x80,regfield|0x400,modrm|0x100,imm|0x100},
     {"sub",0x80,regfield|0x500,modrm|0x100,imm|0x100},
     {"xor",0x80,regfield|0x600,modrm|0x100,imm|0x100},
     {"cmp",0x80,regfield|0x300,modrm|0x100,imm|0x100},
     {"add",0x81,regfield,modrm,imm},
     {"or", 0x81,regfield|0x100,modrm,imm},
     {"adc",0x81,regfield|0x200,modrm,imm},
     {"sbb",0x81,regfield|0x300,modrm,imm},
     {"and",0x81,regfield|0x400,modrm,imm},
     {"sub",0x81,regfield|0x500,modrm,imm},
     {"xor",0x81,regfield|0x600,modrm,imm},
     {"cmp",0x81,regfield|0x300,modrm,imm},
     {"test",0x82,modrm|0x100,reg|0x100},

};


